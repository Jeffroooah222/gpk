#!/usr/bin/env node

'use strict';

process.title = 'gpk';

const {install, run} = require('../lib/gpk');
const {processArgs} = require('../lib/cli');

const cmds = {
  install:  {
    args: {'min': 0, 'max': Infinity},
    params: {
      production: {
        value: false,
        valid: a => (a === true || a === false),
        fallback: false
      }
    }
  },
  test: {
    args: {'min': 0, 'max': 0},
    params: {}
  },
  run: {
    args: {'min': 1, 'max': 1},
    params: {}
  }
};

const {cmd, args, params} = processArgs(process.argv, cmds);

(async () => {
  const cwd = process.cwd();
  let code = 0;

  switch (cmd) {
    case 'install':
      await install(cwd);
      break;
    case 'test':
      code = await run(cwd, 'test');
      break;
    case 'run':
      code = await run(cwd, args[0]);
      break;
    default:
      console.log('Unrecognized command.');
  }

  process.exit(code);
})().catch((err) => {
  console.error(err.stack);
  process.exit(1);
});
